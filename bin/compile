#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast and fail hard.
set -eo pipefail


BUILD_DIR=$1
CACHE_DIR=$2




if [ -e $CACHE_DIR/haste ]; then
  rm -rf $FIXED_HOME/.haste
  mv  $CACHE_DIR/haste $FIXED_HOME/.haste
else
cd $BUILD_DIR
cabal install haste-compiler --reinstall
export PATH=$BUILD_DIR/.cabal/bin:$PATH
haste-boot
fi

haste-inst install haste-perch
haste-inst install hplayground


cd $BUILD_DIR
cabal install cpphs -j5 --disable-library-profiling --disable-executable-profiling --disable-shared  --reinstall --force-reinstalls
cabal install  -j5 --disable-library-profiling --disable-executable-profiling --disable-shared  --reinstall --force-reinstalls
echo "-----> Caching Cabal packages"
shopt -s extglob
export PATH=$BUILD_DIR/.cabal/bin:$PATH 
echo $PATH

cp -r $FIXED_HOME/.haste  $CACHE_DIR/haste
rm -rf $BUILD_DIR/.haste
mv  $FIXED_HOME/.haste $BUILD_DIR
