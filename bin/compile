#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast and fail hard.
set -eo pipefail

BUILD_DIR=$1
CACHE_DIR=$2

echo "Cache dir name:"
echo $CACHE_DIR
echo "Build dir name:"
echo $BUILD_DIR

FIXED_HOME=/app

mkdir -p $CACHE_DIR

if [ ! -e $CACHE_DIR/ghc ]; then
  GHC_URL="http://informatik.uni-kiel.de/~sad/ghc.tar.gz"
  echo "-----> Downloading GHC"
  curl -# --max-time 120 -L "$GHC_URL" | tar xz -C $CACHE_DIR
fi

# Restore GHC registry if available
if [ -e $CACHE_DIR/dotghc ]; then
  rm -rf $FIXED_HOME/app/.ghc
  mv $CACHE_DIR/dotghc $FIXED_HOME/.ghc
fi

# Fix directory
mv $CACHE_DIR/ghc $FIXED_HOME

# Restore Cabal cache or download an empty environemt
if [ -e $CACHE_DIR/cabal ]; then
  rm -rf $FIXED_HOME/.cabal
  mv $CACHE_DIR/cabal $FIXED_HOME/.cabal
elif [ ! -e $FIXED_HOME/.cabal ]; then
  CABAL_URL="http://informatik.uni-kiel.de/~sad/cabal.tar.gz"
  echo "-----> Downloading Cabal"
  curl -# --max-time 120 -L "$CABAL_URL" | tar xz -C $FIXED_HOME
fi

# Set LD_LIBRARAY_PATH and link essential libraries
mkdir -p $FIXED_HOME/usr/lib
ln -s /usr/lib/libgmp.so.3.5.2 $FIXED_HOME/usr/lib/libgmp.so
export LD_LIBRARY_PATH=$FIXED_HOME/usr/lib

# Set PATH
export PATH=$FIXED_HOME/ghc/bin:$FIXED_HOME/.cabal/bin$PATH

echo "-----> Updating Cabal"
cabal update
ghc-pkg unregister MFlow --force
ghc-pkg unregister  tcache-AWS --force
ghc-pkg unregister  aws --force
ghc-pkg unregister  http-conduit --force
ghc-pkg unregister  http-client-conduit --force
ghc-pkg unregister  warp-tls --force
ghc-pkg unregister warp --force
ghc-pkg unregister  wai --force
ghc-pkg unregister  conduit --force


.3 http-conduit-1.9.5.3 xml-conduit-1.1.0.9 zlib-conduit-1.0.0 attoparsec-condu
t-1.0.1.2 persistent-template-1.2.0.6 persistent-sqlite-1.2.1 persistent-1.2.3.
 monad-logger-0.3.3.1 wai-2.0.0 simple-sendfile-0.2.13 network-conduit-1.0.0 bl
ze-builder-conduit-1.0.0 (use --force to override)
echo "-----> Release the hounds! Installing application"
cd $BUILD_DIR
cabal install monadloc-pp -j5 --disable-library-profiling --disable-executable-profiling --disable-shared --reinstall --force-reinstalls 
cabal install warp -j5 --disable-library-profiling --disable-executable-profiling --disable-shared --reinstall --force-reinstalls 

cabal install -j5 --disable-library-profiling --disable-executable-profiling --disable-shared --reinstall --force-reinstalls 
echo "-----> Caching Cabal packages"
echo $FIXED_HOME/.ghc
shopt -s extglob
rm $FIXED_HOME/.cabal/bin/!(cabal|happy)
mv $FIXED_HOME/.cabal $CACHE_DIR/cabal
mv $FIXED_HOME/ghc $CACHE_DIR/ghc
mv $FIXED_HOME/.ghc $CACHE_DIR/dotghc

echo "Cache dir size:"
du -ms $CACHE_DIR
echo "Build dir size:"
du -ms $BUILD_DIR

